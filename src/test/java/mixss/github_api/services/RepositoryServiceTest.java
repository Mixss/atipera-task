package mixss.github_api.services;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import mixss.github_api.apiclients.BranchesFromRepoApiClient;
import mixss.github_api.apiclients.ReposFromUserApiClient;
import mixss.github_api.execptions.ApiErrorReposnseException;
import mixss.github_api.execptions.ApiNotFoundException;
import mixss.github_api.execptions.ApiResponseBadFormatException;
import mixss.github_api.results.BranchResult;
import mixss.github_api.results.ReposAndBranchesResult;
import mixss.github_api.results.RepositoryResult;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.when;

class RepositoryServiceTest {

    RepositoryService service;
    String username = "Mixss";
    String repositoryName = "statystyk-codzienny";
    String repoApiResult = "[ { \"name\": \"holidays\", \"commit\": { \"sha\": \"debba4b4a6e2e3c25a92d4f492b118023b22819a\", \"url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/commits/debba4b4a6e2e3c25a92d4f492b118023b22819a\" }, \"protected\": false }, { \"name\": \"master\", \"commit\": { \"sha\": \"ab8010e673219b8d4ac4bbdbf17d19c39251b3b5\", \"url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/commits/ab8010e673219b8d4ac4bbdbf17d19c39251b3b5\" }, \"protected\": false }, { \"name\": \"new\", \"commit\": { \"sha\": \"b75f21e52f43d507480f9ca9b56afdd84fd78289\", \"url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/commits/b75f21e52f43d507480f9ca9b56afdd84fd78289\" }, \"protected\": false } ]";
    String reposApiResultNoFork = "[ { \"id\": 475567908, \"node_id\": \"R_kgDOHFiXJA\", \"name\": \"statystyk-codzienny\", \"full_name\": \"Mixss/statystyk-codzienny\", \"private\": false, \"owner\": { \"login\": \"Mixss\", \"id\": 19227717, \"node_id\": \"MDQ6VXNlcjE5MjI3NzE3\", \"avatar_url\": \"https://avatars.githubusercontent.com/u/19227717?v=4\", \"gravatar_id\": \"\", \"url\": \"https://api.github.com/users/Mixss\", \"html_url\": \"https://github.com/Mixss\", \"followers_url\": \"https://api.github.com/users/Mixss/followers\", \"following_url\": \"https://api.github.com/users/Mixss/following{/other_user}\", \"gists_url\": \"https://api.github.com/users/Mixss/gists{/gist_id}\", \"starred_url\": \"https://api.github.com/users/Mixss/starred{/owner}{/repo}\", \"subscriptions_url\": \"https://api.github.com/users/Mixss/subscriptions\", \"organizations_url\": \"https://api.github.com/users/Mixss/orgs\", \"repos_url\": \"https://api.github.com/users/Mixss/repos\", \"events_url\": \"https://api.github.com/users/Mixss/events{/privacy}\", \"received_events_url\": \"https://api.github.com/users/Mixss/received_events\", \"type\": \"User\", \"site_admin\": false }, \"html_url\": \"https://github.com/Mixss/statystyk-codzienny\", \"description\": \"Discord bot with everyday statistics\", \"fork\": false, \"url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny\", \"forks_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/forks\", \"keys_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/keys{/key_id}\", \"collaborators_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/collaborators{/collaborator}\", \"teams_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/teams\", \"hooks_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/hooks\", \"issue_events_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/issues/events{/number}\", \"events_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/events\", \"assignees_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/assignees{/user}\", \"branches_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/branches{/branch}\", \"tags_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/tags\", \"blobs_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/blobs{/sha}\", \"git_tags_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/tags{/sha}\", \"git_refs_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/refs{/sha}\", \"trees_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/trees{/sha}\", \"statuses_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/statuses/{sha}\", \"languages_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/languages\", \"stargazers_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/stargazers\", \"contributors_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/contributors\", \"subscribers_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/subscribers\", \"subscription_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/subscription\", \"commits_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/commits{/sha}\", \"git_commits_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/commits{/sha}\", \"comments_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/comments{/number}\", \"issue_comment_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/issues/comments{/number}\", \"contents_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/contents/{+path}\", \"compare_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/compare/{base}...{head}\", \"merges_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/merges\", \"archive_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/{archive_format}{/ref}\", \"downloads_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/downloads\", \"issues_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/issues{/number}\", \"pulls_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/pulls{/number}\", \"milestones_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/milestones{/number}\", \"notifications_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/notifications{?since,all,participating}\", \"labels_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/labels{/name}\", \"releases_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/releases{/id}\", \"deployments_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/deployments\", \"created_at\": \"2022-03-29T18:21:31Z\", \"updated_at\": \"2023-02-11T12:16:12Z\", \"pushed_at\": \"2023-03-22T08:17:10Z\", \"git_url\": \"git://github.com/Mixss/statystyk-codzienny.git\", \"ssh_url\": \"git@github.com:Mixss/statystyk-codzienny.git\", \"clone_url\": \"https://github.com/Mixss/statystyk-codzienny.git\", \"svn_url\": \"https://github.com/Mixss/statystyk-codzienny\", \"homepage\": null, \"size\": 2958, \"stargazers_count\": 1, \"watchers_count\": 1, \"language\": \"Python\", \"has_issues\": true, \"has_projects\": true, \"has_downloads\": true, \"has_wiki\": false, \"has_pages\": false, \"has_discussions\": true, \"forks_count\": 1, \"mirror_url\": null, \"archived\": false, \"disabled\": false, \"open_issues_count\": 3, \"license\": null, \"allow_forking\": true, \"is_template\": false, \"web_commit_signoff_required\": false, \"topics\": [], \"visibility\": \"public\", \"forks\": 1, \"open_issues\": 3, \"watchers\": 1, \"default_branch\": \"master\" } ]";
    String reposApiResultFork = "[ { \"id\": 475567908, \"node_id\": \"R_kgDOHFiXJA\", \"name\": \"statystyk-codzienny\", \"full_name\": \"Mixss/statystyk-codzienny\", \"private\": false, \"owner\": { \"login\": \"Mixss\", \"id\": 19227717, \"node_id\": \"MDQ6VXNlcjE5MjI3NzE3\", \"avatar_url\": \"https://avatars.githubusercontent.com/u/19227717?v=4\", \"gravatar_id\": \"\", \"url\": \"https://api.github.com/users/Mixss\", \"html_url\": \"https://github.com/Mixss\", \"followers_url\": \"https://api.github.com/users/Mixss/followers\", \"following_url\": \"https://api.github.com/users/Mixss/following{/other_user}\", \"gists_url\": \"https://api.github.com/users/Mixss/gists{/gist_id}\", \"starred_url\": \"https://api.github.com/users/Mixss/starred{/owner}{/repo}\", \"subscriptions_url\": \"https://api.github.com/users/Mixss/subscriptions\", \"organizations_url\": \"https://api.github.com/users/Mixss/orgs\", \"repos_url\": \"https://api.github.com/users/Mixss/repos\", \"events_url\": \"https://api.github.com/users/Mixss/events{/privacy}\", \"received_events_url\": \"https://api.github.com/users/Mixss/received_events\", \"type\": \"User\", \"site_admin\": false }, \"html_url\": \"https://github.com/Mixss/statystyk-codzienny\", \"description\": \"Discord bot with everyday statistics\", \"fork\": true, \"url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny\", \"forks_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/forks\", \"keys_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/keys{/key_id}\", \"collaborators_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/collaborators{/collaborator}\", \"teams_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/teams\", \"hooks_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/hooks\", \"issue_events_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/issues/events{/number}\", \"events_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/events\", \"assignees_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/assignees{/user}\", \"branches_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/branches{/branch}\", \"tags_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/tags\", \"blobs_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/blobs{/sha}\", \"git_tags_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/tags{/sha}\", \"git_refs_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/refs{/sha}\", \"trees_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/trees{/sha}\", \"statuses_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/statuses/{sha}\", \"languages_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/languages\", \"stargazers_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/stargazers\", \"contributors_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/contributors\", \"subscribers_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/subscribers\", \"subscription_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/subscription\", \"commits_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/commits{/sha}\", \"git_commits_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/git/commits{/sha}\", \"comments_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/comments{/number}\", \"issue_comment_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/issues/comments{/number}\", \"contents_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/contents/{+path}\", \"compare_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/compare/{base}...{head}\", \"merges_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/merges\", \"archive_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/{archive_format}{/ref}\", \"downloads_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/downloads\", \"issues_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/issues{/number}\", \"pulls_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/pulls{/number}\", \"milestones_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/milestones{/number}\", \"notifications_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/notifications{?since,all,participating}\", \"labels_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/labels{/name}\", \"releases_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/releases{/id}\", \"deployments_url\": \"https://api.github.com/repos/Mixss/statystyk-codzienny/deployments\", \"created_at\": \"2022-03-29T18:21:31Z\", \"updated_at\": \"2023-02-11T12:16:12Z\", \"pushed_at\": \"2023-03-22T08:17:10Z\", \"git_url\": \"git://github.com/Mixss/statystyk-codzienny.git\", \"ssh_url\": \"git@github.com:Mixss/statystyk-codzienny.git\", \"clone_url\": \"https://github.com/Mixss/statystyk-codzienny.git\", \"svn_url\": \"https://github.com/Mixss/statystyk-codzienny\", \"homepage\": null, \"size\": 2958, \"stargazers_count\": 1, \"watchers_count\": 1, \"language\": \"Python\", \"has_issues\": true, \"has_projects\": true, \"has_downloads\": true, \"has_wiki\": false, \"has_pages\": false, \"has_discussions\": true, \"forks_count\": 1, \"mirror_url\": null, \"archived\": false, \"disabled\": false, \"open_issues_count\": 3, \"license\": null, \"allow_forking\": true, \"is_template\": false, \"web_commit_signoff_required\": false, \"topics\": [], \"visibility\": \"public\", \"forks\": 1, \"open_issues\": 3, \"watchers\": 1, \"default_branch\": \"master\" } ]";
    @Mock
    ReposFromUserApiClient reposFromUserApiClient;
    @Mock
    BranchesFromRepoApiClient branchesFromRepoApiClient;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        service = new RepositoryService(reposFromUserApiClient, branchesFromRepoApiClient);
    }

    @Test
    void getReposWithoutForks_ReturnsCorrectValue_WhenNoFork() throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();
        when(reposFromUserApiClient.getReposFromUser(username)).thenReturn(mapper.readTree(reposApiResultNoFork));
        when(branchesFromRepoApiClient.getBranchesFromRepo(username, repositoryName)).thenReturn(mapper.readTree(repoApiResult));

        // expected result
        List<BranchResult> expectedBranches = List.of(new BranchResult("holidays", "debba4b4a6e2e3c25a92d4f492b118023b22819a"), new BranchResult("master", "ab8010e673219b8d4ac4bbdbf17d19c39251b3b5"), new BranchResult("new", "b75f21e52f43d507480f9ca9b56afdd84fd78289"));
        List<RepositoryResult> expectedRepositories = List.of(new RepositoryResult(repositoryName, expectedBranches));
        ReposAndBranchesResult expectedResult = new ReposAndBranchesResult(username, expectedRepositories);
        ReposAndBranchesResult result = service.getReposWithoutForks(username);
        assertEquals(expectedResult, result);
    }

    @Test
    void getReposWithoutForks_ReturnsCorrectValue_WhenFork() throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();
        when(reposFromUserApiClient.getReposFromUser(username)).thenReturn(mapper.readTree(reposApiResultFork));
        when(branchesFromRepoApiClient.getBranchesFromRepo(username, repositoryName)).thenReturn(mapper.readTree(repoApiResult));

        // expected result
        ReposAndBranchesResult expectedResult = new ReposAndBranchesResult(username, new ArrayList<>());
        ReposAndBranchesResult result = service.getReposWithoutForks(username);
        assertEquals(expectedResult, result);
    }

}